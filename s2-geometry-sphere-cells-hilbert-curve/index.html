<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="GEO,翻译," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="迁移的老的文章
–
翻译自 Google’s S2, geometry on the sphere, cells and Hilbert curve
–
Google S2 库  是个珍宝，不仅因为它在空间索引方面的优秀表现，也因为它已经诞生 4 年多却没有受到应有的重视。S2 库被用在 Google Map、MongoDB、Foursquare 上；但除了 Foursquare 的一篇论文、Go">
<meta property="og:type" content="article">
<meta property="og:title" content="Google S2，球面几何，希尔伯特曲线">
<meta property="og:url" content="efeiefei.github.io/s2-geometry-sphere-cells-hilbert-curve/index.html">
<meta property="og:site_name" content="不停的飞啊飞">
<meta property="og:description" content="迁移的老的文章
–
翻译自 Google’s S2, geometry on the sphere, cells and Hilbert curve
–
Google S2 库  是个珍宝，不仅因为它在空间索引方面的优秀表现，也因为它已经诞生 4 年多却没有受到应有的重视。S2 库被用在 Google Map、MongoDB、Foursquare 上；但除了 Foursquare 的一篇论文、Go">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-Hilbert_curve.gif">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-hilbert_begin.png">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efe-ghost-hilbert_middle.png">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-s2_cell_area.png">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-cells_representation.png">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-cell_15_level.png">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-level_15_8.png">
<meta property="og:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-covering_ipython.png">
<meta property="og:updated_time" content="2017-03-04T19:18:45.161Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Google S2，球面几何，希尔伯特曲线">
<meta name="twitter:description" content="迁移的老的文章
–
翻译自 Google’s S2, geometry on the sphere, cells and Hilbert curve
–
Google S2 库  是个珍宝，不仅因为它在空间索引方面的优秀表现，也因为它已经诞生 4 年多却没有受到应有的重视。S2 库被用在 Google Map、MongoDB、Foursquare 上；但除了 Foursquare 的一篇论文、Go">
<meta name="twitter:image" content="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-Hilbert_curve.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="efeiefei.github.io/s2-geometry-sphere-cells-hilbert-curve/"/>





  <title> Google S2，球面几何，希尔伯特曲线 | 不停的飞啊飞 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6faaf23f3cd047d4b0d3a2ec50770e4c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">不停的飞啊飞</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="efeiefei.github.io/s2-geometry-sphere-cells-hilbert-curve/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="虞连飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不停的飞啊飞">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Google S2，球面几何，希尔伯特曲线
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-05T03:09:17+08:00">
                2017-03-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/s2-geometry-sphere-cells-hilbert-curve/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="s2-geometry-sphere-cells-hilbert-curve/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/s2-geometry-sphere-cells-hilbert-curve/" class="leancloud_visitors" data-flag-title="Google S2，球面几何，希尔伯特曲线">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><em>迁移的老的文章</em></p>
<p>–</p>
<p>翻译自 <a href="http://blog.christianperone.com/2015/08/googles-s2-geometry-on-the-sphere-cells-and-hilbert-curve/" target="_blank" rel="external">Google’s S2, geometry on the sphere, cells and Hilbert curve</a></p>
<p>–</p>
<p><a href="https://code.google.com/archive/p/s2-geometry-library/" target="_blank" rel="external">Google S2 库 </a> 是个珍宝，不仅因为它在空间索引方面的优秀表现，也因为它已经诞生 4 年多却没有受到应有的重视。S2 库被用在 Google Map、MongoDB、Foursquare 上；但除了 Foursquare 的一篇论文、<a href="https://docs.google.com/presentation/d/1Hl4KapfAENAOf4gv-pSngKwvS_jwNVHRPZTTDzXXn6Q/view#slide=id.i0" target="_blank" rel="external">Google 的幻灯片 </a> 以及源代码的注释，你不能找到任何相关文章或文档。你也许在努力的寻找 S2 的 bingding，但官方代码库已经丢失了 Python 库的 Swig 文件，感谢 <a href="https://github.com/micolous/s2-geometry-library" target="_blank" rel="external"> 一些 fork</a>使我们还能获取 Python 的一部分 binging。据说最近 Google 正积极的对 S2 进行开发，也许不久我们就能获得这个库更详细的信息，但我决定分享一些使用该库的样例，还有该库这么酷的原因。</p>
<h2 id="了解 cell"><a href="# 了解 cell" class="headerlink" title="了解 cell"></a>了解 cell</h2><p>你会在整个 S2 代码里面看到 <code>cell</code> 的概念。Cell 是球面（对我们来说是地球，但不局限于此）层次分解之后对 region 和 point 的紧凑的表示。Region 也可以使用同样的 Cell 近似表示，这种 Cell 有不少优秀的属性：</p>
<ul>
<li>特别紧凑（由 64-bit 整数表示）</li>
<li>具有地理特性上的解决方案（译者注：resolution for geographical features）</li>
<li>分层的（具有不同 level，相似 level 含有相似的范围）</li>
<li>对任意 region 的包含查询非常快</li>
</ul>
<p>首先，S2 将球面上的 point/region 投影到立方体上，立方体的每个面都有一棵四叉树，球面上的点就投影在这棵四叉树上。然后，进行一些转换（详细原因查看 <a href="https://docs.google.com/presentation/d/1Hl4KapfAENAOf4gv-pSngKwvS_jwNVHRPZTTDzXXn6Q/view#slide=id.i22" target="_blank" rel="external">Google 的幻灯片</a>）将空间离散。接着，Cell 被映射在<a href="https://en.wikipedia.org/wiki/Hilbert_curve" target="_blank" rel="external"> 希尔伯特曲线 </a> 上，这也是 S2 如此优秀的原因。希尔伯特曲线是一种空间填充曲线，它将多维转为一维，并拥有特殊的空间特征：含有局域性信息。</p>
<h2 id="希尔伯特曲线"><a href="# 希尔伯特曲线" class="headerlink" title="希尔伯特曲线"></a>希尔伯特曲线</h2><p><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-Hilbert_curve.gif" alt="hilbert_curve"></p>
<p>希尔伯特曲线是空间填充曲线，它覆盖了整个 n- 维空间。为了理解它的工作原理，你可以想象一条长长的绳子被以特殊的方式放置在空间中，使得这条绳子经过空间中的每个方形区域，从而填满了整个空间。为了将 2D point 映射在希尔伯特曲线上，你只需要选取该 point 所在位置的那条长长的绳子上的点就可以了。为了更容易理解希尔伯特曲线，你可以使用 <a href="http://bit-player.org/extras/hilbert/hilbert-mapping.html" target="_blank" rel="external"> 这个交互式样例</a>，点击曲线上任意一点将会显示在绳子上这个点的位置，反之亦然。</p>
<p>在下面这幅图中，希尔伯特曲线最开始的点也位于图片下方绳子的最开始位置。<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-hilbert_begin.png" alt="hilbert_begin"></p>
<p>下面这幅图含有很多的点，很容易可以看到希尔伯特曲线是如何表示空间位置的。可以看到，曲线（一维表示，最下方的线）上离得越近的点同样在 2D 空间（x,y 平面）离得越近。然而，也可以看到，反过来并不一定正确，在 x,y 平面上相近的 2D point 在希尔伯特曲线上却不一定相近。<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efe-ghost-hilbert_middle.png" alt="hilber_middel"></p>
<p>S2 使用希尔伯特曲线来枚举 cell，意味着 cell value 相近的在空间上也相近。这种思想与层次分解相结合，便得到了索引与查询速度都非常快的框架。在开始具体示例之前，我们看一下 cell 是如何使用 64-bit 整数来表示的。</p>
<p><em>如果对希尔伯特曲线感兴趣，<a href="http://datagenetics.com/blog/march22013/index.html" target="_blank" rel="external">这篇文章 </a> 直观的展现了该曲线的属性。</em></p>
<h2 id="cell 的表示"><a href="#cell 的表示" class="headerlink" title="cell 的表示"></a>cell 的表示 </h2><p> 就像我已经提到的，cell 具有不同的 level，可以覆盖不同的 region。在 S2 库中含有层次分解的 30 个 level。Google 幻灯片中展示了各种 cell level 以及他们可以覆盖的范围，如下图：<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-s2_cell_area.png" alt="s2_cell_area"></p>
<p>可以看到，S2 一个非常酷的特点是地球上每 cm<sup>2</sup>都可以用 64-bit 整数来表示。</p>
<p>cell 使用如下模式来表示：<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-cells_representation.png" alt="cell_representation"></p>
<p>第一个表示一个叶子 cell，叶子 cell 表示最小的区域，通常用来表示 point。正如你看到的，初始的 3 个 bit 被保留下来存储球面投影到立方体的面，紧跟着的是希尔伯特曲线上 cell 的位置，然后是一个为 <code>1</code> 的 bit，用以识别 cell 的 level。</p>
<p>所以，检查 cell 的 level，需要做的就是检查 cell 表示中最后一个<code>1</code>bit 出现的位置。包含关系的检查，验证一个 cell 是否在另一个 cell 中，需要做的仅仅是一个前缀对比。这些操作非常快，也只有希尔伯特曲线及层次分解方法的使用才能将其变为可能。</p>
<h2 id="覆盖 region"><a href="# 覆盖 region" class="headerlink" title="覆盖 region"></a>覆盖 region</h2><p>如果想要产生一些 cell 来覆盖一个 region，你可以使用库里的一个方法，传入 cell 的最大数量、cell 的最大 level、cell 的最小 level 这些参数。下面的例子中，我使用 S2 库来 <strong> 提取一些机器学习的二进制特征 </strong>，指定 level 为 15：<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-cell_15_level.png" alt="cell_15_level"><br> 上面图片中使用透明的多边形覆盖了我所在城市感兴趣的整个区域，那些就是 cell 股改的区域。我在最大 level 及最小 level 都是使用的 15，所以每个 cell 都覆盖了相似的区域大小。如果我将最小 level 设为 8（使其可以使用更大的 cell），S2 库将会使用更少的 cell，并保持近似的精度，如下：<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-level_15_8.png" alt="cell_15_8"><br>可以看到，现在我们在中央使用更大的 cell，在周边使用小一些的 cell 以保持精度。</p>
<p>## 示例<br><em>* In this tutorial I used the Python 2.7 bindings from the following repository. The instructions to compile and install it are present in the readme of the repository so I won’t repeat it here.</em><br>The first step to convert Latitude/Longitude points to the cell representation are shown below:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> s2</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>latlng = s2.S2LatLng.FromDegrees(<span class="number">-30.043800</span>, <span class="number">-51.140220</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cell = s2.S2CellId.FromLatLng(latlng)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cell.level()</div><div class="line"><span class="number">30</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cell.id()</div><div class="line"><span class="number">10743750136202470315</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cell.ToToken()</div><div class="line"><span class="number">951977</span>d377e723ab</div></pre></td></tr></table></figure></p>
<p>As you can see, we first create an object of the class <strong>S2LatLng</strong> to represent the lat/lng point and then we feed it into the <strong>S2CellId</strong> class to build the cell representation. After that, we can get the level and id of the class. There is also a method called <strong>ToToken</strong> that converts the integer representation to a compact alphanumerical representation that you can parse it later using <strong>FromToken</strong> method.</p>
<p>You can also get the parent cell of that cell (one level above it) and use containment methods to check if a cell is contained by another cell:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>parent = cell.parent()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> parent.level()</div><div class="line"><span class="number">29</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>parent.id()</div><div class="line"><span class="number">10743750136202470316</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>parent.ToToken()</div><div class="line"><span class="number">951977</span>d377e723ac</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cell.contains(parent)</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>parent.contains(cell)</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>As you can see, the level of the parent is one above the children cell (in our case, a leaf cell). The ids are also very similar except for the level of the cell and the containment checking is really fast (it is only checking the range of the children cells of the parent cell).</p>
<p>These cells can be stored on a database and they will perform quite well on a BTree index.  In order to create a collection of cells that will cover a region, you can use the <strong>S2RegionCoverer</strong> class like in the example below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>region_rect = S2LatLngRect(</div><div class="line">        S2LatLng.FromDegrees(<span class="number">-51.264871</span>, <span class="number">-30.241701</span>),</div><div class="line">        S2LatLng.FromDegrees(<span class="number">-51.04618</span>, <span class="number">-30.000003</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coverer = S2RegionCoverer()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coverer.set_min_level(<span class="number">8</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coverer.set_max_level(<span class="number">15</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coverer.set_max_cells(<span class="number">500</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>covering = coverer.GetCovering(region_rect)</div></pre></td></tr></table></figure>
<p>First of all, we defined a <strong>S2LatLngRect</strong> which is a rectangle delimiting the region that we want to cover. There are also other classes that you can use (to build polygons for instance), the <strong>S2RegionCoverer</strong> works with classes that uses the <strong>S2Region</strong> class as base class. After defining the rectangle, we instantiate the <strong>S2RegionCoverer</strong> and then set the aforementioned min/max levels and the max number of the cells that we want the approximation to generate.</p>
<p>If you wish to plot the covering, you can use Cartopy, Shapely and matplotlib, like in the example below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">from</span> s2 <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> Polygon</div><div class="line"><span class="keyword">import</span> cartopy.crs <span class="keyword">as</span> ccrs</div><div class="line"><span class="keyword">import</span> cartopy.io.img_tiles <span class="keyword">as</span> cimgt</div><div class="line">proj = cimgt.MapQuestOSM()</div><div class="line">plt.figure(figsize=(<span class="number">20</span>,<span class="number">20</span>), dpi=<span class="number">200</span>)</div><div class="line">ax = plt.axes(projection=proj.crs)</div><div class="line">ax.add_image(proj, <span class="number">12</span>)</div><div class="line">ax.set_extent([<span class="number">-51.411886</span>, <span class="number">-50.922470</span>,</div><div class="line">               <span class="number">-30.301314</span>, <span class="number">-29.94364</span>])</div><div class="line">region_rect = S2LatLngRect(</div><div class="line">    S2LatLng.FromDegrees(<span class="number">-51.264871</span>, <span class="number">-30.241701</span>),</div><div class="line">    S2LatLng.FromDegrees(<span class="number">-51.04618</span>, <span class="number">-30.000003</span>))</div><div class="line">coverer = S2RegionCoverer()</div><div class="line">coverer.set_min_level(<span class="number">8</span>)</div><div class="line">coverer.set_max_level(<span class="number">15</span>)</div><div class="line">coverer.set_max_cells(<span class="number">500</span>)</div><div class="line">covering = coverer.GetCovering(region_rect)</div><div class="line">geoms = []</div><div class="line"><span class="keyword">for</span> cellid <span class="keyword">in</span> covering:</div><div class="line">    new_cell = S2Cell(cellid)</div><div class="line">    vertices = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">4</span>):</div><div class="line">        vertex = new_cell.GetVertex(i)</div><div class="line">        latlng = S2LatLng(vertex)</div><div class="line">        vertices.append((latlng.lat().degrees(),</div><div class="line">                         latlng.lng().degrees()))</div><div class="line">    geo = Polygon(vertices)</div><div class="line">    geoms.append(geo)</div><div class="line"><span class="keyword">print</span> <span class="string">"Total Geometries: &#123;&#125;"</span>.format(len(geoms))</div><div class="line">    </div><div class="line">ax.add_geometries(geoms, ccrs.PlateCarree(), facecolor=<span class="string">'coral'</span>,</div><div class="line">                  edgecolor=<span class="string">'black'</span>, alpha=<span class="number">0.4</span>)</div><div class="line">plt.show()</div></pre></td></tr></table></figure>
<p>And the result will be the one below:<br><img src="http://7xrcvy.com1.z0.glb.clouddn.com/efei-ghost-covering_ipython.png" alt="covering_ipython"></p>
<p>There are a lot of stuff in the S2 API, and I really recommend you to explore and read the source-code, it is really helpful. The S2 cells can be used for indexing and in key-value databases, it can be used on B Trees with really good efficiency and also even for Machine Learning purposes (which is my case), anyway, it is a very useful tool that you should keep in your toolbox. I hope you enjoyed this little tutorial !</p>
<p>– Christian S. Perone</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/GEO/" rel="tag"># GEO</a>
          
            <a href="/tags/翻译/" rel="tag"># 翻译</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/tlv-varint-thrift/" rel="next" title="TLV 格式 及 VARINT 数值压缩存储方法">
                <i class="fa fa-chevron-left"></i> TLV 格式 及 VARINT 数值压缩存储方法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/hexo-github/" rel="prev" title="搭建个人博客：Github、Hexo">
                搭建个人博客：Github、Hexo <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="s2-geometry-sphere-cells-hilbert-curve/"
           data-title="Google S2，球面几何，希尔伯特曲线" data-url="efeiefei.github.io/s2-geometry-sphere-cells-hilbert-curve/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="虞连飞" />
          <p class="site-author-name" itemprop="name">虞连飞</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#了解 cell"><span class="nav-number">1.</span> <span class="nav-text">了解 cell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#希尔伯特曲线"><span class="nav-number">2.</span> <span class="nav-text">希尔伯特曲线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cell 的表示"><span class="nav-number">3.</span> <span class="nav-text">cell 的表示 </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#覆盖 region"><span class="nav-number">4.</span> <span class="nav-text">覆盖 region</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">虞连飞</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"yulianfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("1xBqOtWzvHP0PyoPMY6ege0i-gzGzoHsz", "EdyR2G04iNnC0uNd8XKsyQtx");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


  

</body>
</html>
